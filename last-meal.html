<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Time Tracker">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <meta name="msapplication-TileImage" content="/icons/icon-192x192.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root" style="height: calc(100vh - 55px); display: flex; flex-direction: column;"></div>
  <footer style="text-align: center; padding: 10px; font-size: 0.8em; color: #666;">
    <a href="index.html">Time tracker</a> | Meal tracker
  </footer>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const STORAGE_KEY = 'meals-tracker';
    const CURRENT_DATA_VERSION = 1;
    const MIGRATIONS = [
      (data) => {
        // Migration version 1: Convert mealsByDay values from array of timestamps to array of objects with type and time
        console.log("Running migration 1 for object:", data);
        
        if (data.dataVersion != 1 || data.dataVersion != undefined) {
          return;
        }
        data.dataVersion = 1;
        let loggingDays =  Object.keys(data.mealsByDay);
        console.log("Logging days:", loggingDays);
        
        for (let key in loggingDays) {
          let day = loggingDays[key];
          
          data.mealsByDay[day] = [...data.mealsByDay[day].map((timestamp) => { return { type: 'custom', time: timestamp } })];
        }
      }
    ];

const applyMigrations = (data) => {
  for (let i = 0; i < MIGRATIONS.length; i++) {
    MIGRATIONS[i](data);
  }
};    

const getToday = () => {
  const d = new Date();
  return d.toISOString().slice(0, 10); // YYYY-MM-DD
};

const getMeals = () => {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) {
    return { lastMealTime: null, mealsByDay: {}, dataVersion: CURRENT_DATA_VERSION };
  }
  let data = JSON.parse(saved);
  applyMigrations(data);
  return data;
};

const saveMeals = (meals) => {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(meals));
};

const LastMeal = () => {
  const [meals, setMeals] = useState(getMeals());
  const today = getToday();
  const todayMeals = meals.mealsByDay[today] || [];
  const lastMealTime = meals.lastMealTime;
  const [elapsed, setElapsed] = useState('');

  useEffect(() => {
    const updateElapsed = () => {
      if (lastMealTime) {
        const diff = Math.floor((Date.now() - lastMealTime) / 1000);
        const hours = Math.floor(diff / 3600);
        const minutes = Math.floor((diff % 3600) / 60);
        const seconds = diff % 60;
        setElapsed(`${hours}h ${minutes}m ${seconds}s`);
      } else {
        setElapsed('No meal recorded today');
      }
    };
    updateElapsed();
    const interval = setInterval(updateElapsed, 1000);
    return () => clearInterval(interval);
  }, [lastMealTime]);

  const addSnack = () => {
    updateMeal('snack', true);
  };

  const addLunch = () => {
    updateMeal('lunch', true);
  };

  const updateMeal = (type, needUpdateElapsepTime) => {
    const now = Date.now();
    const updatedMeals = { ...meals };
    updatedMeals.mealsByDay[today] = [...(updatedMeals.mealsByDay[today] || []), { type: type, time: now}];
    if (needUpdateElapsepTime) {
      updatedMeals.lastMealTime = now;
    }
    setMeals(updatedMeals);
    saveMeals(updatedMeals);
  };

  const isAlreadyLunchToday = () => {
    return todayMeals.some(meal => meal.type === 'lunch');
  }

  return (
    <div>
      <div style={{textAlign: 'center', margin: '20px'}}>
        <h2>⏱️: {elapsed}</h2>
      </div>
      <button
        style={{
          padding: '10px',
          backgroundColor: '#28a745',
          color: '#fff',
          border: 'none',
          cursor: 'pointer'
        }}
        onClick={addSnack}
      >
        Snack
      </button>
      <button
        style={{
          padding: '10px',
          backgroundColor: isAlreadyLunchToday() ? '#6c757d' : '#28a745',
          color: '#fff',
          border: 'none',
          cursor: 'pointer',
          marginLeft: '10px'
        }}
        onClick={addLunch}
        disabled={isAlreadyLunchToday()}
      >
        Lunch
      </button>
      <div style={{marginTop: '20px'}}>
        <strong>Today's meals:</strong>
        <ul>
          {todayMeals.map((meal, idx) => (
            <li key={idx}>
             { meal.type } - { new Date(meal.time).toLocaleTimeString() }
            </li>
          ))}
        </ul>
      </div>
    </div>
  );
};

    ReactDOM.render(<LastMeal />, document.getElementById('root'));
  </script>
</body>
</html>
