<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Time Tracker</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Time Tracker">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <meta name="msapplication-TileImage" content="/icons/icon-192x192.png">
  <meta name="msapplication-TileColor" content="#ffffff">
  <link rel="icon" href="icons/favicon.ico" type="image/x-icon">
  <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root" style="height: 100vh; display: flex; flex-direction: column;"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const TodayHistory = ({ taskTimes, taskColors, filterDate }) => {
      function isToday(date, filterDate) {
        return date.getDate() === filterDate.getDate() &&
              date.getMonth() === filterDate.getMonth() &&
              date.getFullYear() === filterDate.getFullYear();
      }

      const allSessions = Object.keys(taskTimes).flatMap((taskKey) => {
        const [taskName, date] = taskKey.split('_');
        const sessions = taskTimes[taskKey]?.sessions || [];
        return sessions.map((session) => ({
          taskName,
          start: new Date(session.start),
          end: new Date(session.end),
          color: taskColors[taskName],
        }));
      }).filter(task => isToday(task.start, filterDate)).sort((a, b) => a.start - b.start);

      if (allSessions.length === 0) return <p>No tasks completed today.</p>;

      const firstTaskTime = allSessions[0].start;
      const lastTaskTime = allSessions[allSessions.length - 1].end;
      const firstHour = firstTaskTime.getHours();
      const lastHour = lastTaskTime.getHours() + 1;

      return (
        <div style={{ display: 'flex', position: 'relative', border: '1px solid #ccc', borderRadius: '5px', flexGrow: 1, overflow: 'hidden', marginTop: '10px' }}>
          <div style={{ width: '50px', borderRight: '1px solid #ccc', textAlign: 'right', paddingRight: '5px', boxSizing: 'border-box' }}>
            {[...Array(lastHour - firstHour).keys()].map((hour) => (
              <div key={hour} style={{ height: `${100 / (lastHour - firstHour)}%`, borderBottom: '1px dotted #ccc', boxSizing: 'border-box' }}>
                {hour + firstHour}:00
              </div>
            ))}
          </div>
          <div style={{ flex: 1, position: 'relative' }}>
            {allSessions.map((session, index) => {
              const startOffset = (session.start.getHours() * 60 + session.start.getMinutes()) - (firstHour * 60);
              const endOffset = (session.end.getHours() * 60 + session.end.getMinutes()) - (firstHour * 60);
              const top = (startOffset / ((lastHour - firstHour) * 60)) * 100;
              const height = ((endOffset - startOffset) / ((lastHour - firstHour) * 60)) * 100;
              return (
                <div
                  key={index}
                  style={{
                    position: 'absolute',
                    top: `${top}%`,
                    height: `${height}%`,
                    left: '0',
                    right: '0',
                    backgroundColor: session.color,
                    color: 'white',
                    padding: '5px',
                    boxSizing: 'border-box',
                    border: '1px solid #000',
                  }}
                >
                  <div>{session.taskName}</div>
                  <div>{session.start.toLocaleTimeString()} - {session.end.toLocaleTimeString()}</div>
                </div>
              );
            })}
          </div>
        </div>
      );
    };

    const TimeTracker = () => {
      const tasks = ['Work', 'Startup', 'Fitness', 'Leisure', 'Other'];
      const taskColors = {
        Work: '#4caf50',
        Startup: '#2196f3',
        Fitness: '#ff9800',
        Leisure: '#9c27b0',
        Other: '#f44336',
      };
      const [currentTask, setCurrentTask] = useState(null);
      const [taskTimes, setTaskTimes] = useState({});
      const [startTime, setStartTime] = useState(null);
      const [currentTime, setCurrentTime] = useState(Date.now());

      useEffect(() => {
        const storedTimes = JSON.parse(localStorage.getItem('taskTimes')) || {};
        setTaskTimes(storedTimes);
      }, []);

      useEffect(() => {
        localStorage.setItem('taskTimes', JSON.stringify(taskTimes));
      }, [taskTimes]);

      useEffect(() => {
        if (currentTask) {
          const interval = setInterval(() => {
            setCurrentTime(Date.now());
          }, 1000);
          return () => clearInterval(interval);
        }
      }, [currentTask]);

      const startTimer = (task) => {
        if (currentTask) {
          stopTimer(currentTask);
        }
        setCurrentTask(task);
        let date = new Date();
        setStartTime(date);
        setCurrentTime(date);
      };

      const stopTimer = (task) => {
        if (!startTime) return;

        const elapsed = Date.now() - startTime;
        const today = new Date().toISOString().slice(0, 10);
        const taskKey = `${task}_${today}`;

        setTaskTimes((prev) => {
          const previousTime = prev[taskKey]?.totalTime || 0;
          const sessionLog = prev[taskKey]?.sessions || [];
          const newEntry = {
            totalTime: previousTime + elapsed,
            lastStart: new Date(startTime).toLocaleString(),
            lastEnd: new Date().toLocaleString(),
            sessions: [
              ...sessionLog,
              {
                start: new Date(startTime).toISOString(),
                end: new Date().toISOString(),
              },
            ],
          };
          return { ...prev, [taskKey]: newEntry };
        });

        setStartTime(null);
      };

      const handleTaskClick = (task) => {
        if (currentTask === task) {
          stopTimer(task);
          setCurrentTask(null);
        } else {
          startTimer(task);
        }
      };

      const formatTime = (ms) => {
        const seconds = Math.floor(ms / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      };

      const today = new Date().toISOString().slice(0, 10);

      return (
        <div style={{ padding: '10px', fontFamily: 'Arial, sans-serif', height: '100%', display: 'flex', flexDirection: 'column' }}>
          <h1 style={{ marginBottom: '10px' }}>Time Tracker</h1>
          <div style={{ display: 'flex', flexDirection: 'column', gap: '10px', flexShrink: 0 }}>
            {tasks.map((task) => {
              const taskKey = `${task}_${today}`;
              const totalTime = taskTimes[taskKey]?.totalTime || 0;
              const elapsedTime = currentTask === task && startTime ? currentTime - startTime : 0;
              const currentSessionTime = currentTask === task && startTime ? formatTime(elapsedTime) : null;
              return (
                <button
                  key={task}
                  onClick={() => handleTaskClick(task)}
                  style={{
                    padding: '10px 20px',
                    backgroundColor: currentTask === task ? '#9acd32' : taskColors[task],
                    color: 'white',
                    border: 'none',
                    borderRadius: '5px',
                    cursor: 'pointer',
                    textAlign: 'left',
                  }}
                >
                  <div>{task}</div>
                  <div style={{ fontSize: '1.2em', marginTop: '5px' }}>‚è±Ô∏è: {formatTime(totalTime)}</div>
                  {currentSessionTime && (
                    <div style={{ fontSize: '1.2em', color: 'yellow' }}>üî• Active: {currentSessionTime}</div>
                  )}
                </button>
              );
            })}
          </div>
          <TodayHistory taskTimes={taskTimes} taskColors={taskColors} filterDate={new Date()} />
        </div>
      );
    };

    ReactDOM.render(<TimeTracker />, document.getElementById('root'));
  </script>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('ServiceWorker registered: ', registration);
        }).catch(registrationError => {
          console.log('ServiceWorker registration failed: ', registrationError);
        });
      });
    }
  </script>
</body>
</html>
